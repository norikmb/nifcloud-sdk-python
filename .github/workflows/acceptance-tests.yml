name: Acceptance
on:
  push:
    branches:
      - main
  pull_request:
env:
  NIFCLOUD_DEFAULT_REGION: "jp-east-1"
  NIFCLOUD_ACCESS_KEY_ID: ${{ secrets.NIFCLOUD_ACCESS_KEY_ID }}
  NIFCLOUD_SECRET_ACCESS_KEY: ${{ secrets.NIFCLOUD_SECRET_ACCESS_KEY }}
  NIFCLOUD_STORAGE_ACCESS_KEY_ID: ${{ secrets.NIFCLOUD_STORAGE_ACCESS_KEY_ID }}
  NIFCLOUD_STORAGE_SECRET_ACCESS_KEY: ${{ secrets.NIFCLOUD_STORAGE_SECRET_ACCESS_KEY }}
jobs:
  acceptancetest:
    # ubuntu-24.04 later does not support Python 3.7
    runs-on: ubuntu-22.04
    strategy:
      max-parallel: 1
      matrix:
        python-version: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Sync dependencies
        run: uv sync --frozen

      - name: Check credentials
        id: check-creds
        run: |
          if [ -z "$NIFCLOUD_ACCESS_KEY_ID" ] || [ -z "$NIFCLOUD_SECRET_ACCESS_KEY" ]; then
            echo "has-credentials=false" >> $GITHUB_OUTPUT
            echo "⏭️  Skipping acceptance tests (credentials not configured)"
          else
            echo "has-credentials=true" >> $GITHUB_OUTPUT
          fi

      - name: Run acceptance tests
        if: steps.check-creds.outputs.has-credentials == 'true'
        run: uv run pytest tests/acceptance/minimal --capture=sys -v

      - name: Notice
        if: steps.check-creds.outputs.has-credentials == 'false'
        run: |
          echo "⏭️  Acceptance tests were skipped due to missing credentials."
          echo "To enable acceptance tests, configure these GitHub Secrets:"
          echo "  - NIFCLOUD_ACCESS_KEY_ID"
          echo "  - NIFCLOUD_SECRET_ACCESS_KEY"
          echo "  - NIFCLOUD_STORAGE_ACCESS_KEY_ID (optional)"
          echo "  - NIFCLOUD_STORAGE_SECRET_ACCESS_KEY (optional)"
